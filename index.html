<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>WebAR Floor Placement</title>
  <link rel="stylesheet" href="/src/styles/main.css">
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <!-- A-Frame must be loaded in head before scene -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script>
    // Suppress Three.js useLegacyLights deprecation warning
    // This is a known issue with A-Frame 1.5.0 and Three.js r155+
    (function() {
      const originalWarn = console.warn;
      console.warn = function(...args) {
        if (args[0] && typeof args[0] === 'string' && 
            args[0].includes('useLegacyLights')) {
          return; // Suppress this specific warning
        }
        originalWarn.apply(console, args);
      };
    })();
  </script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen visible">
    <div class="loading-content">
      <img id="logo" src="/assets/logo.svg" alt="Logo" class="logo">
      
      <!-- Start AR Button (shown initially) -->
      <button id="start-ar-btn" class="start-ar-btn">
        <span class="btn-text">Start AR</span>
      </button>
      
      <!-- Loading State (hidden initially) -->
      <div id="loading-state" class="loading-state hidden">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loading-text">Initializing AR Experience...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p class="progress-text" id="progress-text">0%</p>
      </div>
    </div>
  </div>

  <!-- WebXR Not Supported Screen -->
  <div id="unsupported-screen" class="unsupported-screen">
    <div class="unsupported-content">
      <h2>WebXR Not Supported</h2>
      <p>Your browser does not support WebXR. Please try one of the following:</p>
      <div class="supported-browsers">
        <h3>Android:</h3>
        <ul>
          <li>Chrome 79+</li>
          <li>Samsung Internet 12.0+</li>
          <li>Edge 79+</li>
        </ul>
        <h3>iOS:</h3>
        <ul>
          <li>WebXR Viewer</li>
          <li>Reality Composer</li>
        </ul>
      </div>
      <button class="try-anyway-btn" onclick="window.arApp.tryAnyway()">Try Anyway</button>
    </div>
  </div>

  <!-- Main AR Scene -->
  <a-scene
    id="ar-scene"
    class="hidden"
    webxr="referenceSpaceType: local;
           requiredFeatures: hit-test;
           optionalFeatures: dom-overlay;
           overlayElement: #ui-overlay"
    vr-mode-ui="enabled: false"
    renderer="antialias: true; colorManagement: true"
    loading-screen="enabled: false">
    
    <!-- Assets -->
    <a-assets timeout="30000">
      <!-- Dynamic models will be loaded here -->
    </a-assets>

    <!-- Camera with AR capabilities -->
    <a-entity 
      id="camera-rig"
      position="0 0 0">
      <a-camera 
        id="camera"
        position="0 0 0"
        look-controls="enabled: false"
        wasd-controls="enabled: false">
      </a-camera>
    </a-entity>

    <!-- Hit test marker (world space - NOT inside camera) - Enhanced Reticle -->
    <a-entity
      id="marker"
      hit-test-marker
      visible="false">
      <!-- Outer glow ring -->
      <a-entity
        geometry="primitive: ring; radiusInner: 0.18; radiusOuter: 0.22"
        material="color: #22c55e; opacity: 0.4; transparent: true"
        rotation="-90 0 0">
      </a-entity>
      <!-- Main ring -->
      <a-entity
        geometry="primitive: ring; radiusInner: 0.12; radiusOuter: 0.18"
        material="color: white; opacity: 0.9"
        rotation="-90 0 0">
      </a-entity>
      <!-- Inner animated ring -->
      <a-entity
        geometry="primitive: ring; radiusInner: 0.08; radiusOuter: 0.12"
        material="color: #22c55e; opacity: 0.95"
        rotation="-90 0 0"
        animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dur: 800; loop: true; dir: alternate; easing: easeInOutQuad">
      </a-entity>
      <!-- Center dot -->
      <a-entity
        geometry="primitive: circle; radius: 0.04"
        material="color: white; opacity: 1"
        rotation="-90 0 0">
      </a-entity>
      <!-- Crosshair lines -->
      <a-entity
        geometry="primitive: plane; width: 0.35; height: 0.015"
        material="color: white; opacity: 0.6; transparent: true"
        rotation="-90 0 0"
        position="0 0.001 0">
      </a-entity>
      <a-entity
        geometry="primitive: plane; width: 0.015; height: 0.35"
        material="color: white; opacity: 0.6; transparent: true"
        rotation="-90 0 0"
        position="0 0.001 0">
      </a-entity>
    </a-entity>

    <!-- Model container -->
    <a-entity id="model-container"></a-entity>

    <!-- Lighting -->
    <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
    <a-light type="directional" position="1 2 1" color="#ffffff" intensity="1.0" cast-shadow></a-light>
    <a-light type="hemisphere" color="#ffffff" groundColor="#bbbbbb" intensity="0.5"></a-light>
  </a-scene>

  <!-- UI Overlay -->
  <div id="ui-overlay" class="ui-overlay hidden">
    <!-- Gallery Button -->
    <button id="gallery-btn" class="ui-btn gallery-btn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
      </svg>
      Gallery
    </button>

    <!-- Log Button -->
    <button id="log-btn" class="ui-btn log-btn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      Log
    </button>

    <!-- Log Panel -->
    <div id="log-panel" class="log-panel hidden">
      <div class="log-header">
        <h3>Debug Log</h3>
        <div class="log-actions">
          <button id="copy-log-btn" class="log-action-btn">Copy</button>
          <button id="clear-log-btn" class="log-action-btn">Clear</button>
          <button id="close-log-btn" class="log-action-btn">&times;</button>
        </div>
      </div>
      <div id="log-content" class="log-content"></div>
    </div>

    <!-- Controls Panel -->
    <div id="controls-panel" class="controls-panel">
      <button id="clear-btn" class="ui-btn">Clear</button>
      <button id="reload-btn" class="ui-btn">Reload</button>
      
      <!-- Layer toggles will be added dynamically -->
      <div id="layer-toggles" class="layer-toggles hidden">
        <h3>Layers</h3>
        <div id="layer-buttons"></div>
      </div>
    </div>

    <!-- Gallery Modal -->
    <div id="gallery-modal" class="gallery-modal hidden">
      <div class="gallery-content">
        <button class="close-btn" id="close-gallery">&times;</button>
        <h2>Select Model</h2>
        <div id="model-grid" class="model-grid">
          <!-- Model items will be added dynamically -->
        </div>
      </div>
    </div>

    <!-- Surface Status Badge (always visible during AR) -->
    <div id="surface-status" class="surface-status">
      <div class="status-indicator searching"></div>
      <span class="status-text">Searching for surface...</span>
    </div>

    <!-- Instructions -->
    <div id="instructions" class="instructions">
      <div class="instruction-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
      </div>
      <p>Scan the floor to detect a surface</p>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Debug Info (development only) -->
    <div id="debug-info" class="debug-info hidden">
      <div>FPS: <span id="fps">0</span></div>
      <div>Hit Test: <span id="hit-test-status">inactive</span></div>
      <div>Model: <span id="model-status">none</span></div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="/src/main.js"></script>
</body>
</html>
